<html>
  <head>
    <title>Emulator Agent Embed demonstration</title>
    <script type="module">
      import { emulateSnesConsole } from "./snes.mjs";

      window.onload = async function () {
        let response = await fetch(
          "https://cdn.glitch.global/6acefe06-c905-4b4e-9899-1373a2fe7184/metroid.sfc?v=1728680288564"
        );
        let romBytes = new Uint8Array(await response.arrayBuffer());

        let emulator = emulateSnesConsole(
          romBytes,
          document.querySelector("#container")
        );

        let context = emulator.canvas.getContext("2d");
        context.strokeStyle = "yellow";
        context.lineWidth = 2;
        context.fillStyle = "yellow";
        context.font = "16px monospace";

        function afterRun() {
          let dv = new DataView(
            emulator.retro.get_memory_data(2).slice(0, 0x2000).buffer
          );
          let g = dv.getUint8(0x0998);
          context.fillText("game state 0x" + g.toString(16), 8, 16);
          if (g == 0x2a) {
            let x = dv.getUint8(0x0b04);
            let y = dv.getUint8(0x0b06);
            context.strokeRect(x - 32, y - 32, 64, 64);
          }

          // make up random inputs
          // emulator.input_state["0,1,0,0"] = Math.random() < 0.5;
        }

        emulator.addEventListener("afterRun", afterRun);
      };
    </script>
  </head>
  <body>
    <div id="container"></div>
  </body>
</html>
